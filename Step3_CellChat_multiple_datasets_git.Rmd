---
title: "üî¨ Comparison analysis of multiple datasets using CellChat üó£Ô∏è"
author: "üë® Hongchen Xiao"
date: "üìÖ `r format(Sys.Date(), '%B %d, %Y')`"
bibliography: Bioinformatics.bib
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: true
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    code_folding: show
    theme: cosmo
    highlight: tango
    df_print: paged
    fig_caption: true
    self_contained: true
---


```{r setup, include=FALSE}

# Set global chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>",
  fig.align = "center",
  out.width = "80%",
  dpi = 300,
  cache = FALSE,
  fig.width = 10,
  fig.height = 7,
  dev = "png",
  dev.args = list(bg = "transparent"),
  fig.retina = 2,
  fig.showtext = TRUE,
  results = "hold"
)

# Set general options
options(
  digits = 3,
  width = 120,
  scipen = 999,
  knitr.kable.NA = "",
  knitr.table.format = "html"
)

# Load required packages silently
suppressPackageStartupMessages({
  library(knitr)
  library(kableExtra)
  library(htmltools)
})
```

```{r klippy, echo=FALSE, include=TRUE}
    klippy::klippy(position = c('bottom', 'right'),
                   lang = c('r', 'python', 'bash'),
                   tooltip_message = 'Click to copy',
                   tooltip_success = 'Copied!',
                   color = 'darkRed')
```


```{css, echo=FALSE}

/* Enhanced Custom CSS styling */
body {
  font-family: 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.8;
  color: #2c3e50;
  max-width: 1200px;
  margin: auto;
  padding: 1em;
  background-color: #ffffff;
}

h1, h2, h3, h4 {
  color: #2c3e50;
  font-weight: 600;
  margin-top: 2em;
  border-bottom: 2px solid #eaecef;
  padding-bottom: 0.3em;
}

.title {
  color: #2c3e50;
  text-align: center;
  font-size: 2.8em;
  margin-bottom: 1em;
  font-weight: 700;
  border-bottom: none;
}

.author, .date {
  text-align: center;
  color: #7f8c8d;
  font-size: 1.2em;
  margin-bottom: 2em;
}

/* Code chunks styling */
pre {
  border-radius: 4px;
  background-color: #f8f9fa !important;
  border: 1px solid #e9ecef;
  padding: 1em;
}

code {
  color: #c0392b;
  background-color: #f8f9fa;
  padding: 2px 4px;
  border-radius: 3px;
}

pre.r:before {
  content: "R Script";
  display: block; /* Make the label appear on its own line */
  font-weight: bold;
  color: #555;
  background-color: #eee;
  padding: 5px
}

pre.python:before {
  content: "Python Script";
  display: block; /* Make the label appear on its own line */
  font-weight: bold;
  color: #555;
  background-color: #eee;
  padding: 5px
}

pre.bash:before {
  content: "bash Script";
  display: block; /* Make the label appear on its own line */
  font-weight: bold;
  color: #555;
  background-color: #eee;
  padding: 5px
}




/* Table of contents styling */
#TOC {
  padding: 20px;
  background-color: #f8f9fa;
  border-radius: 5px;
  border: 1px solid #e9ecef;
}

.toc-content {
  padding-left: 1em;
  padding-right: 1em;
}

/* Figure styling */
.figure {
  margin: 2em 0;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  border-radius: 4px;
  overflow: hidden;
}

.caption {
  margin-top: 0.5em;
  color: #666;
  font-style: italic;
}

/* Tables styling */
table {
  width: 100%;
  margin-bottom: 1em;
  border-collapse: collapse;
  border-spacing: 0;
}

thead {
  background-color: #f8f9fa;
}

th, td {
  padding: 8px;
  border: 1px solid #dee2e6;
}

/* Button styling */
.btn-code-chunk {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 0.9em;
  color: #666;
}

/* Links styling */
a {
  color: #0366d6;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Blockquote styling */
blockquote {
  margin: 1em 0;
  padding-left: 1em;
  border-left: 4px solid #e9ecef;
  color: #6c757d;
}
```
# üìñ Introduction

This vignette demonstrates how to use CellChat [@RN23] to identify significant signaling changes across different biological conditions. This analysis is performed on single-cell RNA sequencing (scRNA-seq) data, and follows the general principles of scRNA-seq analysis workflows described in [@RN28]. The analysis can be performed using popular toolkits such as Seurat [@RN26] and Scanpy [@RN27]. We will showcase CellChat's diverse functionalities by applying it to scRNA-seq datasets from two distinct biological conditions: non-lesional (NL, normal) and lesional (LS, diseased) human skin from patients with atopic dermatitis. For a comprehensive comparison of different analysis methods, please refer to [@RN29]comparison.

> **Note:** The two datasets in this tutorial have the same cell population compositions after joint clustering. For a guide on comparing datasets with different cell population compositions, please refer to the [tutorial on Comparison analysis of multiple datasets with different cell type compositions](https://htmlpreview.github.io/?https://github.com/jinworks/CellChat/blob/master/tutorial/Comparison_analysis_of_multiple_datasets_with_different_cellular_compositions.html).

CellChat utilizes a top-down approach to identify signaling changes at multiple levels. It begins with a high-level overview and progressively refines the analysis to reveal detailed insights into altered interactions, cell populations, signaling pathways, and ligand-receptor pairs.

# üìö Load the required libraries
```{r load-libraries, message=FALSE, warning=FALSE}
ptm = Sys.time()
library(CellChat)
library(patchwork)
library(ComplexHeatmap)
library(wordcloud)
library(ggplot2)
library(tidyverse)
library(ggalluvial)
library(ggrepel)
library(igraph)
```

## üìÇ Create a directory to save figures
```{r eval = FALSE}
data.dir <- './comparison'
dir.create(data.dir)
# setwd(data.dir)
```

# üì¶ Load CellChat object of each dataset and merge them together
First, run CellChat on each dataset individually. Then, merge the resulting CellChat objects. If you are using CellChat objects created with a version prior to 1.6.0, please update them using the `updateCellChat` function.
```{r load-and-merge, eval = FALSE}
setwd("D:/Data_Analysis_Practice_2025/scRNAseq/CellChat-main")
cellchat.NL <- readRDS("data/cellchat_humanSkin_NL_analysed.rds")
cellchat.LS <- readRDS("data/cellchat_humanSkin_LS_analysed.rds")
object.list <- list(NL = cellchat.NL, LS = cellchat.LS)
cellchat <- mergeCellChat(object.list, add.names = names(object.list))
cellchat
execution.time = Sys.time() - ptm
print(as.numeric(execution.time, units = "secs"))
```
```{r, eval = FALSE}
# Users can now export the merged CellChat object and the list of the two separate objects for later use
save(object.list, file = "cellchat_object.list_humanSkin_NL_LS.RData")
save(cellchat, file = "cellchat_merged_humanSkin_NL_LS.RData")
```

#  üîç Identify altered interactions and cell populations
CellChat's top-down analytical approach begins with a broad overview of the communication landscape and progressively delves into the finer details. This multi-level analysis identifies signaling changes in interactions, cell populations, pathways, and ligand-receptor pairs.

Initially, CellChat addresses the following key questions:

*   Is there an overall enhancement or suppression of cell-cell communication?
*   Which cell-cell interactions are significantly altered?
*   How do the major signaling sources and targets differ between conditions?

## üìä Compare the total number of interactions and interaction strength
To determine if cell-cell communication is enhanced or suppressed, CellChat compares the total number of interactions and their strengths between the inferred communication networks of different biological conditions.
```{r compare-interactions, eval=FALSE}
ptm = Sys.time()
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1,2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1,2), measure = "weight")

gg1 + gg2

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/compareInteractions_humanSkin_NL_LS.pdf", width = 12, height = 9)
gg1 + gg2
dev.off()

png("comparison/compareInteractions_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
gg1 + gg2
dev.off()
```


<div class="figure" style="text-align: center">
<img src="comparison/compareInteractions_humanSkin_NL_LS.png" alt="compare interactions" width="80%" />
<p class="caption">**Figure 1:** compare Interactions</p>
</div>


## üßê Compare the number of interactions and interaction strength among different cell populations
To pinpoint which cell populations exhibit significant changes in interaction, CellChat provides several visualization options for comparing interaction counts and strengths:

*   **(A) Differential Circle Plot:** Visualizes the differences in interactions between the two datasets.
*   **(B) Differential Heatmap:** Offers a detailed view of the interaction changes.
*   **(C) Side-by-side Circle Plots:** Compares the interaction networks for each dataset individually.
*   **(D) Coarse-grained Analysis:** Allows for the examination of differential interactions at a higher level by aggregating cell populations into defined groups.

### ‚≠ï (A) Circle plot showing differential number of interactions or interaction strength among different cell populations across two datasets
The circle plot visualizes the differential number of interactions or their strengths between the two datasets. Edges colored in $\color{red}{\text{red}}$ represent signaling that is increased in the second dataset, while $\color{blue}{\text{blue}}$ edges indicate decreased signaling compared to the first dataset.

```{r netVisual-diffInteraction, eval=FALSE}

par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight")


```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netVisual_diffInteraction_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight")
dev.off()

png("comparison/netVisual_diffInteraction_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight")
dev.off()
```

<div class="figure" style="text-align: center">
<div style="display:flex; justify-content:space-between;">
  <img src="comparison/netVisual_diffInteraction_humanSkin_NL_LS_1.png" alt="netVisual_diffInteraction" style="width:48%;" />
  <img src="comparison/netVisual_diffInteraction_humanSkin_NL_LS_2.png" alt="your_second_image_alt_text" style="width:48%;" />
</div>
<p class="caption">**Figure 2:** netVisual_diffInteraction</p>
</div>


### üî• (B) Heatmap showing differential number of interactions or interaction strength among different cell populations across two datasets
For a more detailed view, CellChat can generate a heatmap of the differential number of interactions or their strengths.
*   The **top bar plot** shows the total incoming signaling changes for each cell population.
*   The **right bar plot** displays the total outgoing signaling changes.
The height of the bars corresponds to the magnitude of the change between the two conditions. In the heatmap, $\color{red}{\text{red}}$ indicates increased signaling in the second dataset, while $\color{blue}{\text{blue}}$ represents decreased signaling.
```{r netVisual-heatmap, eval=FALSE}
gg1 <- netVisual_heatmap(cellchat)
gg2 <- netVisual_heatmap(cellchat, measure = "weight")

gg1 + gg2

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netVisual_heatmap_humanSkin_NL_LS.pdf", width = 12, height = 9)
gg1 + gg2
dev.off()

png("comparison/netVisual_heatmap_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
gg1 + gg2
dev.off()
```


<div class="figure" style="text-align: center">
<img src="comparison/netVisual_heatmap_humanSkin_NL_LS.png" alt="netVisual_heatmap" width="80%" />
<p class="caption">**Figure 3:** netVisual_heatmap</p>
</div>


### üîµ (C) Circle plot showing the number of interactions or interaction strength among different cell populations across multiple datasets
The differential network analysis shown above is designed for pairwise comparisons. For studies involving more than two datasets, CellChat can visualize the number of interactions or their strengths for each dataset individually.

To ensure consistency in the visualizations across different datasets, CellChat normalizes the node sizes and edge weights by computing the maximum number of cells per cell group and the maximum interaction count (or weight) across all datasets.
  
```{r getMaxWeight, eval=FALSE}
weight.max <- getMaxWeight(object.list, attribute = c("idents","count"))
par(mfrow = c(1,2), xpd=TRUE)

for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netVisual_circle_humanSkin_NL_LS.pdf", width = 12, height = 6)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}
dev.off()

png("comparison/netVisual_circle_humanSkin_NL_LS.png", width = 12, height = 6, units = "in", res = 300)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}
dev.off()
```

<div class="figure" style="text-align: center">
<div style="display:flex; justify-content:space-between;">
  <img src="comparison/netVisual_circle_humanSkin_NL_LS_1.png" alt="netVisual_circle" style="width:48%;" />
  <img src="comparison/netVisual_circle_humanSkin_NL_LS_2.png" alt="your_second_image_alt_text" style="width:48%;" />
</div>
<p class="caption">**Figure 4:** netVisual_circle</p>
</div>

### üü£ (D) Circle plot showing the differential number of interactions or interaction strength among coarse cell types
To simplify the complex network and gain insights at a higher level, CellChat can aggregate cell-cell communication based on predefined cell groups. In this example, we categorize the cell populations into three main types and then re-merge the CellChat objects.
```{r mergecellchat, eval=FALSE}
group.cellType <- c(rep("FIB", 4), rep("DC", 4), rep("TC", 4))
group.cellType <- factor(group.cellType, levels = c("FIB", "DC", "TC"))
object.list <- lapply(object.list, function(x) {mergeInteractions(x, group.cellType)})
cellchat <- mergeCellChat(object.list, add.names = names(object.list))
```

We can then visualize the number of interactions or their strengths between these aggregated cell types for each dataset. 
```{r getmaxweight-2, eval=FALSE}
weight.max <- getMaxWeight(object.list, slot.name = c("idents", "net", "net"), attribute = c("idents","count", "count.merged"))

par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count.merged, weight.scale = T, label.edge= T, edge.weight.max = weight.max[3], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}

```

```{r, echo=FALSE, eval=FALSE}

pdf("comparison/netVisual_circle_humanSkin_NL_LS_merged.pdf", width = 12, height =9)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count.merged, weight.scale = T, label.edge= T, edge.weight.max = weight.max[3], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}
dev.off()

png("comparison/netVisual_circle_humanSkin_NL_LS_merged.png", width = 12, height =9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count.merged, weight.scale = T, label.edge= T, edge.weight.max = weight.max[3], edge.width.max = 12, title.name = paste0("Number of interactions - ", names(object.list)[i]))
}
dev.off()
```


<div class="figure" style="text-align: center">
<div style="display:flex; justify-content:space-between;">
  <img src="comparison/netVisual_circle_humanSkin_NL_LS_merged_1.png" alt="netVisual_circle_merged" style="width:48%;" />
  <img src="comparison/netVisual_circle_humanSkin_NL_LS_merged_2.png" alt="your_second_image_alt_text" style="width:48%;" />
</div>
<p class="caption">**Figure 5:** netVisual_circle_merged</p>
</div>


Similarly, a circle plot can be used to show the differential number of interactions or their strengths between the aggregated cell types. Red edges indicate increased signaling in the second dataset, while blue edges represent decreased signaling. 

```{r netVisual-diffInteraction-merged, eval=FALSE}

par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count.merged", label.edge = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight.merged", label.edge = T)

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netVisual_diffInteraction_humanSkin_NL_LS_merged.pdf", width = 12, height =9  )
par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count.merged", label.edge = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight.merged", label.edge = T)
dev.off()

png("comparison/netVisual_diffInteraction_humanSkin_NL_LS_merged.png", width = 12, height =9, units = "in", res = 300  )
par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "count.merged", label.edge = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight.merged", label.edge = T)
dev.off()
```


<div class="figure" style="text-align: center">
<div style="display:flex; justify-content:space-between;">
  <img src="comparison/netVisual_diffInteraction_humanSkin_NL_LS_merged_1.png" alt="netVisual_circle_merged" style="width:48%;" />
  <img src="comparison/netVisual_diffInteraction_humanSkin_NL_LS_merged_2.png" alt="your_second_image_alt_text" style="width:48%;" />
</div>
<p class="caption">**Figure 6:** netVisual_diffInteraction_merged</p>
</div>


## üéØ Compare the major sources and targets in a 2D space
By plotting the outgoing versus incoming interaction strengths in a 2D space, we can readily identify cell populations that have undergone significant changes in their signaling roles (as senders or receivers) between the datasets.

Follow option (A) to identify the cell populations with the most significant changes, and option (B) to inspect the signaling changes for specific cell populations of interest. 

###  (A) Identify cell populations with significant changes in sending or receiving signals
```{r wrap-plots, eval=FALSE}
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  object.list[[i]] <- netAnalysis_computeCentrality(object.list[[i]])
  gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title = names(object.list)[i], weight.MinMax = weight.MinMax)
}

patchwork::wrap_plots(plots = gg)

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netAnalysis_signalingRole_scatter_humanSkin_NL_LS.pdf", width = 12, height = 9)
patchwork::wrap_plots(plots = gg)
dev.off()

png("comparison/netAnalysis_signalingRole_scatter_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
patchwork::wrap_plots(plots = gg)
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/netAnalysis_signalingRole_scatter_humanSkin_NL_LS.png" alt="netAnalysis_signalingRole_scatter" width="80%" />
<p class="caption">**Figure 7:** netAnalysis_signalingRole_scatter</p>
</div>

The scatter plot reveals that Inflam.DC and cDC1 emerge as major signaling sources and targets in the lesional (LS) condition compared to the non-lesional (NL) one. Additionally, fibroblast populations become more prominent as signaling sources in the LS condition.

### ‚ö°Ô∏è (B) Identify the signaling changes of specific cell populations 
We can now delve deeper and identify the specific signaling pathways that are altered for Inflam.DC and cDC1 between the NL and LS conditions. 

```{r comate-centrality, eval=FALSE}
# compute centrality for each dataset and merge them
object.list <- lapply(object.list, function(x) {
  x <- netAnalysis_computeCentrality(x)
  return(x)
})
cellchat <- mergeCellChat(object.list, add.names = names(object.list))
gg1 <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = "Inflam. DC", signaling.exclude = "MIF")
gg2 <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = "cDC1", signaling.exclude = c("MIF"))

patchwork::wrap_plots(plots = list(gg1,gg2))

execution.time = Sys.time() - ptm
print(as.numeric(execution.time, units = "secs"))
```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netAnalysis_signalingChanges_scatter_humanSkin_NL_LS.pdf", width = 12, height = 9)
patchwork::wrap_plots(plots = list(gg1,gg2))
dev.off()

png("comparison/netAnalysis_signalingChanges_scatter_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
patchwork::wrap_plots(plots = list(gg1,gg2))
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/netAnalysis_signalingChanges_scatter_humanSkin_NL_LS.png" alt="netAnalysis_signalingChanges_scatter" width="80%" />
<p class="caption">**Figure 8:** netAnalysis_signalingChanges_scatter</p>
</div>



#  üß† Identify altered signaling with distinct network architecture and interaction strength
CellChat can identify signaling pathways with significant alterations in their network architecture or interaction strength. It can also classify signaling groups based on their functional or structural similarity across multiple biological conditions.

## üï∏Ô∏è Identify signaling networks with larger (or less) difference as well as signaling groups based on their functional/structure similarity
CellChat performs joint manifold learning and classification of the inferred communication networks based on their functional and topological similarity across different conditions. This analysis is applicable to more than two datasets. 

By quantifying the similarity between the cellular communication networks of signaling pathways across conditions, this analysis highlights potentially altered signaling pathways. CellChat adopts the concept of network rewiring from network biology and hypothesizes that the difference between communication networks may affect biological processes across conditions. UMAP is used for visualizing signaling relationships and interpreting the outputs in an intuitive way. 

**Functional similarity**: A high degree of functional similarity indicates that major senders and receivers are similar, suggesting that the two signaling pathways or ligand-receptor pairs exhibit similar or redundant roles. **NB**: Functional similarity analysis is not applicable to multiple datasets with different cell type compositions. 

**Structural similarity**: Structural similarity is used to compare signaling network structures, without considering the similarity of senders and receivers. **NB**: Structural similarity analysis is applicable to multiple datasets with either the same or vastly different cell type compositions. 

Here, we can run the manifold and classification learning analysis based on functional similarity because the two datasets have the same cell type composition. 

### ‚öôÔ∏è Identify signaling groups based on their functional similarity
```{r enbedding-functional, eval = FALSE}
ptm = Sys.time()

cellchat <- computeNetSimilarityPairwise(cellchat, type = "functional")
cellchat <- netEmbedding(cellchat, type = "functional")
cellchat <- netClustering(cellchat, type = "functional")
# Visualization in 2D-space

netVisual_embeddingPairwise(cellchat, type = "functional", label.size = 3.5)

```

### üèóÔ∏è Identify signaling groups based on structure similarity
```{r enbedding-structural, eval = FALSE}
cellchat <- computeNetSimilarityPairwise(cellchat, type = "structural")
cellchat <- netEmbedding(cellchat, type = "structural")
cellchat <- netClustering(cellchat, type = "structural")
# Visualization in 2D-space

netVisual_embeddingPairwise(cellchat, type = "structural", label.size = 3.5)
netVisual_embeddingPairwiseZoomIn(cellchat, type = "structural", nCol = 2)

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/netVisual_embeddingPairwise_humanSkin_NL_LS.pdf", width = 12, height = 9)
netVisual_embeddingPairwise(cellchat, type = "structural", label.size = 3.5)
netVisual_embeddingPairwiseZoomIn(cellchat, type = "structural", nCol = 2)
dev.off()

png("comparison/netVisual_embeddingPairwise_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
netVisual_embeddingPairwise(cellchat, type = "structural", label.size = 3.5)
netVisual_embeddingPairwiseZoomIn(cellchat, type = "structural", nCol = 2)
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/netVisual_embeddingPairwise_humanSkin_NL_LS_2.png" alt="netVisual_embeddingPairwise" width="80%" />
<p class="caption">**Figure 9:** netVisual_embeddingPairwise</p>
</div>


### üìè Compute and visualize the pathway distance in the learned joint manifold
CellChat can identify signaling networks with larger or smaller differences based on their Euclidean distance in the shared two-dimensional space. A larger distance implies a greater difference between the communication networks of the two datasets in terms of either functional or structural similarity. Note that we only compute the distance for signaling pathways that are present in both datasets. Signaling pathways identified in only one dataset are not considered. For comparisons involving more than three datasets, you can perform pairwise comparisons by modifying the `comparison` parameter in the `rankSimilarity` function.
  
```{r ranksimilarity, eval=FALSE}

rankSimilarity(cellchat, type = "functional")

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/rankSimilarity_humanSkin_NL_LS.pdf", width = 12, height = 9)
rankSimilarity(cellchat, type = "functional")
dev.off()

png("comparison/rankSimilarity_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
rankSimilarity(cellchat, type = "functional")
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/rankSimilarity_humanSkin_NL_LS.png" alt="rankSimilarity" width="80%" />
<p class="caption">**Figure 10:** rankSimilarity</p>
</div>


## üîÑ Identify altered signaling with distinct interaction strength
By comparing the information flow (interaction strength) of each signaling pathway, CellChat identifies pathways that are turned off, decreased, turned on, or increased in one condition compared to another. You can identify altered signaling pathways or ligand-receptor pairs based on the overall information flow (Option A) or by examining outgoing/incoming signaling patterns (Option B). 

### üåä (A) Compare the overall information flow of each signaling pathway or ligand-receptor pair
CellChat can identify conserved and context-specific signaling pathways by comparing the information flow for each pathway. The information flow is defined as the sum of communication probabilities among all pairs of cell groups in the inferred network (i.e., the total weights in the network). 

This bar chart can be plotted in a stacked or non-stacked mode. Significant signaling pathways are ranked based on the differences in their overall information flow between the NL and LS skin conditions. When `do.stat = TRUE`, a paired Wilcoxon test is performed to assess the significance of the difference in information flow between the two conditions. The top signaling pathways colored red are enriched in NL skin, and those colored green are enriched in LS skin.

```{r  ranknet, eval=FALSE}
gg1 <- rankNet(cellchat, mode = "comparison", measure = "weight", sources.use = NULL, targets.use = NULL, stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", measure = "weight", sources.use = NULL, targets.use = NULL, stacked = F, do.stat = TRUE)

gg1 + gg2

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/rankNet_humanSkin_NL_LS.pdf", width = 12, height = 9)
gg1 + gg2
dev.off()

png("comparison/rankNet_humanSkin_NL_LS.pdf", width = 12, height = 9, units = "in", res = 300)
gg1 + gg2
dev.off()
```


<div class="figure" style="text-align: center">
<img src="comparison/rankNet_humanSkin_NL_LS.png" alt="rankNet" width="80%" />
<p class="caption">**Figure 11:** rankNet</p>
</div>  

### üì§üì• (B) Compare outgoing (or incoming) signaling patterns associated with each cell population
The previous analysis summarized the information from both outgoing and incoming signaling. CellChat can also compare the outgoing or incoming signaling patterns between two datasets, allowing for the identification of signaling pathways or ligand-receptors that exhibit different signaling patterns. We can combine all identified signaling pathways from the different datasets and compare them side-by-side, including outgoing, incoming, and overall signaling (aggregated from outgoing and incoming).

CellChat uses a heatmap to show the contribution of signals (signaling pathways or ligand-receptor pairs) to cell groups in terms of outgoing or incoming signaling. In this heatmap, the colorbar represents the relative signaling strength of a pathway across cell groups (values are row-scaled). The top colored bar plot shows the total signaling strength of a cell group by summarizing all pathways in the heatmap. The right grey bar plot shows the total signaling strength of a pathway by summarizing all cell groups.

```{r complexheatmap, eval=FALSE}

i = 1
# combining all the identified signaling pathways from different datasets 
pathway.union <- union(object.list[[i]]@netP$pathways, object.list[[i+1]]@netP$pathways)
netAnalysis_computeCentrality(object.list[[i]])
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i], width = 8, height = 8)
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i+1], width = 8, height = 8)

draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))

execution.time = Sys.time() - ptm
print(as.numeric(execution.time, units = "secs"))
```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/complexheatmap_humanSkin_NL_LS.pdf", width = 12, height = 9)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()

png("comparison/complexheatmap_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/complexheatmap_humanSkin_NL_LS.png" alt="complexheatmap" width="80%" />
<p class="caption">**Figure 12:** complexheatmap</p>
</div>


```{r complexheatmap-2, eval=FALSE}
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i], width = 8, height = 8, color.heatmap = "GnBu")
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i+1], width = 8, height = 8, color.heatmap = "GnBu")

draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/complexheatmap_incoming_humanSkin_NL_LS.pdf", width = 12, height = 9)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()

png("comparison/complexheatmap_incoming_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/complexheatmap_incoming_humanSkin_NL_LS.png" alt="complexheatmap_incoming" width="80%" />
<p class="caption">**Figure 13:** complexheatmap_incoming</p>
</div>


```{r complexheatmap-3, eval=FALSE}
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "all", signaling = pathway.union, title = names(object.list)[i], width = 8, height = 8, color.heatmap = "OrRd")
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "all", signaling = pathway.union, title = names(object.list)[i+1], width = 8, height = 8, color.heatmap = "OrRd")

draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/complexheatmap_all_humanSkin_NL_LS.pdf", width = 12, height = 9)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()

png("comparison/complexheatmap_all_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/complexheatmap_all_humanSkin_NL_LS.png" alt="complexheatmap_all" width="80%" />
<p class="caption">**Figure 14:** complexheatmap_all</p>
</div>

#  üí° Identify the up-gulated and down-regulated signaling ligand-receptor pairs
## üé≤ Identify dysfunctional signaling by comparing the communication probabities  
CellChat can compare the communication probabilities mediated by L-R pairs from certain cell groups to other cell groups. This can be done by setting `comparison` in the function `netVisual_bubble`.  
```{r bubble-plot, eval=FALSE}
ptm = Sys.time()

netVisual_bubble(cellchat, sources.use = 4, targets.use = c(5:11),  comparison = c(1, 2), angle.x = 45)

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/bubble_plot_humanSkin_NL_LS.pdf", width = 12, height = 9)
netVisual_bubble(cellchat, sources.use = 4, targets.use = c(5:11),  comparison = c(1, 2), angle.x = 45)
dev.off()

png("comparison/bubble_plot_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
netVisual_bubble(cellchat, sources.use = 4, targets.use = c(5:11),  comparison = c(1, 2), angle.x = 45)
dev.off()
```


<div class="figure" style="text-align: center">
<img src="comparison/bubble_plot_humanSkin_NL_LS.png" alt="bubble_plot" width="80%" />
<p class="caption">**Figure 15:** bubble_plot</p>
</div>

Moreover, CellChat can identify the up-regulated (increased) and down-regulated (decreased) signaling ligand-receptor pairs in one dataset compared to the other dataset. This can be done by specifying `max.dataset` and `min.dataset` in the function `netVisual_bubble`. The increased signaling means these signaling have higher communication probability (strength) in the second dataset compared to the first dataset. The ligand-receptor pairs shown in the bubble plot can be accessed via `gg1$data`.

```{r bubble-plot-2, eval=FALSE}
gg1 <- netVisual_bubble(cellchat, sources.use = 4, targets.use = c(5:11),  comparison = c(1, 2), max.dataset = 2, title.name = "Increased signaling in LS", angle.x = 45, remove.isolate = T)
gg2 <- netVisual_bubble(cellchat, sources.use = 4, targets.use = c(5:11),  comparison = c(1, 2), max.dataset = 1, title.name = "Decreased signaling in LS", angle.x = 45, remove.isolate = T)

gg1 + gg2

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/bubble_plot_up_down_humanSkin_NL_LS.pdf", width = 12, height = 9 )
gg1 + gg2
dev.off()

png("comparison/bubble_plot_up_down_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300 )
gg1 + gg2
dev.off()
```



NB: The ligand-receptor pairs shown in the bubble plot can be accessed via `signaling.LSIncreased = gg1$data`. 

<div class="figure" style="text-align: center">
<img src="comparison/bubble_plot_up_down_humanSkin_NL_LS.png" alt="bubble_plot_up_down" width="80%" />
<p class="caption">**Figure 16:** bubble_plot_up_down</p>
</div>


## üî¨ Identify dysfunctional signaling by using differential expression analysis
The above method for identifying the upgulated and down-regulated signaling is perfomed by comparing the communication probability between two datasets for each L-R pair and each pair of cell groups. Alternative, we can identify the upgulated and down-regulated signaling ligand-receptor pairs based on the differential expression analysis (DEA). Specifically, we perform differential expression analysis between two biological conditions (i.e., NL and LS) for each cell group, and then obtain the upgulated and down-regulated signaling based on the fold change of ligands in the sender cells and receptors in the receiver cells. 

Of note, users may observe the same LR pairs appearing in both the up-regulated and down-regulated results due to the fact that DEA between conditions is performed for each cell group.  To perform DEA between conditions by ignoring cell group information, users can set `group.DE.combined = TRUE` in `identifyOverExpressedGenes` for CellChat v2.1.1. 

```{r mapping-dea, eval=FALSE}
# define a positive dataset, i.e., the dataset with positive fold change against the other dataset
pos.dataset = "LS"
# define a char name used for storing the results of differential expression analysis
features.name = paste0(pos.dataset, ".merged")

# perform differential expression analysis 
# Of note, compared to CellChat version < v2, CellChat v2 now performs an ultra-fast Wilcoxon test using the presto package, which gives smaller values of logFC. Thus we here set a smaller value of thresh.fc compared to the original one (thresh.fc = 0.1). Users can also provide a vector and dataframe of customized DEGs by modifying the cellchat@var.features$LS.merged and cellchat@var.features$LS.merged.info. 

cellchat <- identifyOverExpressedGenes(cellchat, group.dataset = "datasets", pos.dataset = pos.dataset, features.name = features.name, only.pos = FALSE, thresh.pc = 0.1, thresh.fc = 0.05,thresh.p = 0.05, group.DE.combined = FALSE) 

# map the results of differential expression analysis onto the inferred cell-cell communications to easily manage/subset the ligand-receptor pairs of interest
net <- netMappingDEG(cellchat, features.name = features.name, variable.all = TRUE)
# extract the ligand-receptor pairs with upregulated ligands in LS
net.up <- subsetCommunication(cellchat, net = net, datasets = "LS",ligand.logFC = 0.05, receptor.logFC = NULL)
# extract the ligand-receptor pairs with upregulated ligands and upregulated receptors in NL, i.e.,downregulated in LS
net.down <- subsetCommunication(cellchat, net = net, datasets = "NL",ligand.logFC = -0.05, receptor.logFC = NULL)
```

Since the signaling genes in the `net.up` and `net.down` might be complex with multi-subunits, we can do further deconvolution to obtain the individual signaling genes.
```{r extract-genes, eval=FALSE}
gene.up <- extractGeneSubsetFromPair(net.up, cellchat)
gene.down <- extractGeneSubsetFromPair(net.down, cellchat)
```

Users can also find all the significant outgoing/incoming/both signaling according to the customized features and cell groups of interest
```{r find-enriched-signaling, eval=FALSE}
df <- findEnrichedSignaling(object.list[[2]], features = c("CCL19", "CXCL12"), idents = c("Inflam. FIB", "COL11A1+ FIB"), pattern ="outgoing")
```

## üé® Visualize the identified up-regulated and down-regulated signaling ligand-receptor pairs
CellChat can visualize the identified up-regulated and down-regulated signaling ligand-receptor pairs using bubble plot (option A), chord diagram (option B) or wordcloud (option C).

### ü´ß (A) Bubble plot
We then visualize the upgulated and down-regulated signaling ligand-receptor pairs using bubble plot or chord diagram. 
```{r bubble-plot-3, eval=FALSE}
pairLR.use.up = net.up[, "interaction_name", drop = F]
gg1 <- netVisual_bubble(cellchat, pairLR.use = pairLR.use.up, sources.use = 4, targets.use = c(5:11), comparison = c(1, 2),  angle.x = 90, remove.isolate = T,title.name = paste0("Up-regulated signaling in ", names(object.list)[2]))
pairLR.use.down = net.down[, "interaction_name", drop = F]
gg2 <- netVisual_bubble(cellchat, pairLR.use = pairLR.use.down, sources.use = 4, targets.use = c(5:11), comparison = c(1, 2),  angle.x = 90, remove.isolate = T,title.name = paste0("Down-regulated signaling in ", names(object.list)[2]))

gg1 + gg2

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/bubble_plot_up_down_DEA_humanSkin_NL_LS.pdf", width = 12, height = 9 )
gg1 + gg2
dev.off()

png("comparison/bubble_plot_up_down_DEA_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300 )
gg1 + gg2
dev.off()
```



<div class="figure" style="text-align: center">
<img src="comparison/bubble_plot_up_down_DEA_humanSkin_NL_LS.png" alt="bubble_plot_up_down_DEA" width="80%" />
<p class="caption">**Figure 17:** bubble_plot_up_down_DEA</p>
</div>

### üé∂ (B) Chord diagram
Visualize the upgulated and down-regulated signaling ligand-receptor pairs using Chord diagram
```{r chord-diagram, eval=FALSE}
# Chord diagram

par(mfrow = c(1,2), xpd=TRUE)
netVisual_chord_gene(object.list[[2]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.up, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Up-regulated signaling in ", names(object.list)[2]))
netVisual_chord_gene(object.list[[1]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.down, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Down-regulated signaling in ", names(object.list)[2]))

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_diagram_up_down_DEA_humanSkin_NL_LS.pdf", width = 12, height = 9 )
par(mfrow = c(1,2), xpd=TRUE)
netVisual_chord_gene(object.list[[2]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.up, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Up-regulated signaling in ", names(object.list)[2]))
netVisual_chord_gene(object.list[[1]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.down, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Down-regulated signaling in ", names(object.list)[2]))
dev.off()

png("comparison/chord_diagram_up_down_DEA_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300 )
par(mfrow = c(1,2), xpd=TRUE)
netVisual_chord_gene(object.list[[2]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.up, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Up-regulated signaling in ", names(object.list)[2]))
netVisual_chord_gene(object.list[[1]], sources.use = 4, targets.use = c(5:11), slot.name = 'net', net = net.down, lab.cex = 0.8, small.gap = 3.5, title.name = paste0("Down-regulated signaling in ", names(object.list)[2]))
dev.off()
```


### ‚òÅÔ∏è (C) Wordcloud plot
Visualize the enriched ligands, signaling,or ligand-receptor pairs in one condition compared to another condition using wordcloud
```{r wordcloud, eval=FALSE}

# visualize the enriched ligands in the first condition
par(mfrow = c(1,2), xpd=TRUE)
computeEnrichmentScore(net.down, species = 'human', variable.both = TRUE)
# visualize the enriched ligands in the second condition
computeEnrichmentScore(net.up, species = 'human', variable.both = TRUE)

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/wordcloud_up_down_DEA_humanSkin_NL_LS.pdf", width = 8, height = 6 )
par(mfrow = c(1,2), xpd=TRUE)
computeEnrichmentScore(net.down, species = 'human', variable.both = TRUE)
# visualize the enriched ligands in the second condition
computeEnrichmentScore(net.up, species = 'human', variable.both = TRUE)
dev.off()

png("comparison/wordcloud_up_down_DEA_humanSkin_NL_LS.png", width = 8, height = 6, units = "in", res = 300 )
par(mfrow = c(1,2), xpd=TRUE)
computeEnrichmentScore(net.down, species = 'human', variable.both = TRUE)
# visualize the enriched ligands in the second condition
computeEnrichmentScore(net.up, species = 'human', variable.both = TRUE)
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/wordcloud_up_down_DEA_humanSkin_NL_LS.png" alt="wordcloud_up_down_DEA" width="80%" />
<p class="caption">**Figure 18:** wordcloud_up_down_DEA</p>
</div>



#  üëÄ Visually compare cell-cell communication using Hierarchy plot, Circle plot or Chord diagram
Similar to the [CellChat analysis of individual dataset](https://htmlpreview.github.io/?https://github.com/jinworks/CellChat/blob/master/tutorial/CellChat-vignette.html), CellChat can visually compare cell-cell communication networks using hierarchy plot, circle plot, chord diagram, or heatmap.  More details on the visualization can be found in the [CellChat analysis of individual dataset](https://htmlpreview.github.io/?https://github.com/jinworks/CellChat/blob/master/tutorial/CellChat-vignette.html). 

**Edge color/weight, node color/size/shape**: In all visualization plots, edge colors are consistent with the sources as sender, and edge weights are proportional to the interaction strength. Thicker edge line indicates a stronger signal. In the **Hierarchy plot and Circle plot**, circle sizes are proportional to the number of cells in each cell group. In the hierarchy plot, solid and open circles represent source and target, respectively. In the **Chord diagram**, the inner thinner bar colors represent the targets that receive signal from the corresponding outer bar. The inner bar size is proportional to the signal strength received by the targets. Such inner bar is helpful for interpreting the complex chord diagram. Note that there exist some inner bars without any chord for some cell groups, please just igore it because this is an issue that has not been addressed by [circlize](https://github.com/jokergoo/circlize) package. 

```{r cxcl-hierarchy, eval=FALSE}
pathways.show <- c("CXCL") 
weight.max <- getMaxWeight(object.list, slot.name = c("netP"), attribute = pathways.show) # control the edge weights across different datasets

par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "circle", edge.weight.max = weight.max[1], edge.width.max = 10, signaling.name = paste(pathways.show, names(object.list)[i]))
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/hierarchy_CXCL_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "circle", edge.weight.max = weight.max[1], edge.width.max = 10, signaling.name = paste(pathways.show, names(object.list)[i]))
}
dev.off()

png("comparison/hierarchy_CXCL_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "circle", edge.weight.max = weight.max[1], edge.width.max = 10, signaling.name = paste(pathways.show, names(object.list)[i]))
}
dev.off()
```


<div class="figure" style="text-align: center">
<img src="comparison/hierarchy_CXCL_humanSkin_NL_LS.png" alt="hierarchy_CXCL" width="80%" />
<p class="caption">**Figure 19:** hierarchy_CXCL</p>
</div>


```{r cxcl-heatmap, eval=FALSE}
pathways.show <- c("CXCL") 

par(mfrow = c(1,2), xpd=TRUE)
ht <- list()
for (i in 1:length(object.list)) {
  ht[[i]] <- netVisual_heatmap(object.list[[i]], signaling = pathways.show, color.heatmap = "Reds",title.name = paste(pathways.show, "signaling ",names(object.list)[i]))
}
ComplexHeatmap::draw(ht[[1]] + ht[[2]], ht_gap = unit(0.5, "cm"))

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/heatmap_CXCL_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1,2), xpd=TRUE)
ht <- list()
for (i in 1:length(object.list)) {
  ht[[i]] <- netVisual_heatmap(object.list[[i]], signaling = pathways.show, color.heatmap = "Reds",title.name = paste(pathways.show, "signaling ",names(object.list)[i]))
}
ComplexHeatmap::draw(ht[[1]] + ht[[2]], ht_gap = unit(0.5, "cm"))
dev.off()

png("comparison/heatmap_CXCL_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
ht <- list()
for (i in 1:length(object.list)) {
  ht[[i]] <- netVisual_heatmap(object.list[[i]], signaling = pathways.show, color.heatmap = "Reds",title.name = paste(pathways.show, "signaling ",names(object.list)[i]))
}
ComplexHeatmap::draw(ht[[1]] + ht[[2]], ht_gap = unit(0.5, "cm"))
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/heatmap_CXCL_humanSkin_NL_LS.png" alt="heatmap_CXCL" width="80%" />
<p class="caption">**Figure 20:** heatmap_CXCL</p>
</div>


```{r cxcl-chord, eval=FALSE}
# Chord diagram
pathways.show <- c("CXCL") 

par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "chord", signaling.name = paste(pathways.show, names(object.list)[i]))
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_CXCL_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "chord", signaling.name = paste(pathways.show, names(object.list)[i]))
}
dev.off()

png("comparison/chord_CXCL_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_aggregate(object.list[[i]], signaling = pathways.show, layout = "chord", signaling.name = paste(pathways.show, names(object.list)[i]))
}
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/chord_CXCL_humanSkin_NL_LS.png" alt="chord_CXCL" width="80%" />
<p class="caption">**Figure 21:** chord_CXCL</p> 
</div>


For the chord diagram, CellChat has an independent function `netVisual_chord_cell` to flexibly visualize the signaling network by adjusting different parameters in the [circlize](https://github.com/jokergoo/circlize) package. For example, we can define a named char vector `group` to create multiple-group chord diagram, e.g., grouping cell clusters into different cell types.
```{r chord-group, eval=FALSE}
# Chord diagram
group.cellType <- c(rep("FIB", 4), rep("DC", 4), rep("TC", 4)) # grouping cell clusters into fibroblast, DC and TC cells
names(group.cellType) <- levels(object.list[[1]]@idents)
pathways.show <- c("CXCL") 

par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_cell(object.list[[i]], signaling = pathways.show, group = group.cellType, title.name = paste0(pathways.show, " signaling network - ", names(object.list)[i]))
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_cellType_CXCL_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_cell(object.list[[i]], signaling = pathways.show, group = group.cellType, title.name = paste0(pathways.show, " signaling network - ", names(object.list)[i]))
}
dev.off()

png("comparison/chord_cellType_CXCL_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1,2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_cell(object.list[[i]], signaling = pathways.show, group = group.cellType, title.name = paste0(pathways.show, " signaling network - ", names(object.list)[i]))
}
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/chord_cellType_CXCL_humanSkin_NL_LS.png" alt=" chord_cellType_CXCL" width="80%" />
<p class="caption">**Figure 22:**  chord_cellType_CXCL</p>
</div>


Using chord diagram, CellChat provides two functions `netVisual_chord_cell` and `netVisual_chord_gene` for visualizing cell-cell communication with different purposes and different levels. `netVisual_chord_cell` is used for visualizing the cell-cell communication between different cell groups (where each sector in the chord diagram is a cell group), and `netVisual_chord_gene` is used for visualizing the cell-cell communication mediated by mutiple ligand-receptors or signaling pathways (where each sector in the chord diagram is a ligand, receptor or signaling pathway.)

```{r compare-interactions-2, eval=FALSE}

par(mfrow = c(1, 2), xpd=TRUE)
# compare all the interactions sending from Inflam.FIB to DC cells
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = 4, targets.use = c(5:8), lab.cex = 0.5, title.name = paste0("Signaling from Inflam.FIB - ", names(object.list)[i]))
}

``` 

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_gene_humanSkin_NL_LS.pdf", width = 12, height = 9)
par(mfrow = c(1, 2), xpd=TRUE)
# compare all the interactions sending from Inflam.FIB to DC cells
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = 4, targets.use = c(5:8), lab.cex = 0.5, title.name = paste0("Signaling from Inflam.FIB - ", names(object.list)[i]))
}
dev.off()

png("comparison/chord_gene_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
par(mfrow = c(1, 2), xpd=TRUE)
# compare all the interactions sending from Inflam.FIB to DC cells
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = 4, targets.use = c(5:8), lab.cex = 0.5, title.name = paste0("Signaling from Inflam.FIB - ", names(object.list)[i]))
}
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/chord_gene_humanSkin_NL_LS.png" alt="chord_gene" width="80%" />
<p class="caption">**Figure 23:** chord_gene</p>
</div>

```{r compare-interactions-3, eval=FALSE}

# compare all the interactions sending from fibroblast to inflamatory immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2, 3, 4), targets.use = c(8,10),  title.name = paste0("Signaling received by Inflam.DC and .TC - ", names(object.list)[i]), legend.pos.x = 10)
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_gene_fibroblast_inflam.pdf", width = 12, height = 9)
# compare all the interactions sending from fibroblast to inflamatory immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2, 3, 4), targets.use = c(8,10),  title.name = paste0("Signaling received by Inflam.DC and .TC - ", names(object.list)[i]), legend.pos.x = 10)
}
dev.off()

png("comparison/chord_gene_fibroblast_inflam.png", width = 12, height = 9, units = "in", res = 300)
# compare all the interactions sending from fibroblast to inflamatory immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2, 3, 4), targets.use = c(8,10),  title.name = paste0("Signaling received by Inflam.DC and .TC - ", names(object.list)[i]), legend.pos.x = 10)
}
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/chord_gene_fibroblast_inflam.png" alt="chord_gene_fibroblast_inflam" width="80%" />
<p class="caption">**Figure 24:** chord_gene_fibroblast_inflam</p>
</div>

```{r compare-interactions-4, eval=FALSE}

# show all the significant signaling pathways from fibroblast to immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2,3,4), targets.use = c(5:11),slot.name = "netP", title.name = paste0("Signaling pathways sending from fibroblast - ", names(object.list)[i]), legend.pos.x = 10)
}

```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/chord_gene_fibroblast_immune.pdf", width = 12, height = 9)
# show all the significant signaling pathways from fibroblast to immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2,3,4), targets.use = c(5:11),slot.name = "netP", title.name = paste0("Signaling pathways sending from fibroblast - ", names(object.list)[i]), legend.pos.x = 10)
}
dev.off()

png("comparison/chord_gene_fibroblast_immune.png", width = 12, height = 9, units = "in", res = 300)
# show all the significant signaling pathways from fibroblast to immune cells
par(mfrow = c(1, 2), xpd=TRUE)
for (i in 1:length(object.list)) {
  netVisual_chord_gene(object.list[[i]], sources.use = c(1,2,3,4), targets.use = c(5:11),slot.name = "netP", title.name = paste0("Signaling pathways sending from fibroblast - ", names(object.list)[i]), legend.pos.x = 10)
}
dev.off()
```

NB: Please ignore the note when generating the plot such as "Note: The first link end is drawn out of sector 'MIF'.‚Äù. If the gene names are overlapped, you can adjust the argument `small.gap` by decreasing the value. 

<div class="figure" style="text-align: center">
<img src="comparison/chord_gene_fibroblast_immune.png" alt="chord_gene_fibroblast_immune" width="80%" />
<p class="caption">**Figure 25:** chord_gene_fibroblast_immune</p>
</div>


#  üß¨ Compare the signaling gene expression distribution between different datasets 
We can plot the gene expression distribution of signaling genes related to L-R pairs or signaling pathway using a Seurat wrapper function `plotGeneExpression`.  
```{r plot-gene-expression, eval=FALSE}
cellchat@meta$datasets = factor(cellchat@meta$datasets, levels = c("NL", "LS")) # set factor level

plotGeneExpression(cellchat, signaling = "CXCL", split.by = "datasets", colors.ggplot = T, type = "violin")

execution.time = Sys.time() - ptm
print(as.numeric(execution.time, units = "secs"))
```

```{r, echo=FALSE, eval=FALSE}
pdf("comparison/plotGeneExpression_CXCL_humanSkin_NL_LS.pdf", width = 12, height = 9)
plotGeneExpression(cellchat, signaling = "CXCL", split.by = "datasets", colors.ggplot = T, type = "violin")
dev.off()

png("comparison/plotGeneExpression_CXCL_humanSkin_NL_LS.png", width = 12, height = 9, units = "in", res = 300)
plotGeneExpression(cellchat, signaling = "CXCL", split.by = "datasets", colors.ggplot = T, type = "violin")
dev.off()
```

<div class="figure" style="text-align: center">
<img src="comparison/plotGeneExpression_CXCL_humanSkin_NL_LS.png" alt="plotGeneExpression_CXCL" width="80%" />
<p class="caption">**Figure 26:** plotGeneExpression_CXCL</p>
</div>



# ‚ÑπÔ∏è Session Info
```{r}
sessionInfo()
```

# üîó References


